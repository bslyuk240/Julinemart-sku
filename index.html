<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JulineMart SKU Generator</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #121822;
      --muted: #a8b3cf;
      --text: #e8eefc;
      --accent: #4f2cac;
      --accent-2: #ff8a3d;
      --warn: #f59e0b;
      --danger: #ef4444;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: linear-gradient(180deg, #0b0f14, #0a0d12 60%, #0c1017); color: var(--text); }
    header { padding: 20px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: rgba(11,15,20,0.8); backdrop-filter: blur(8px); z-index: 5; display:flex; align-items:center; gap:8px; }
    h1 { margin: 0; font-size: 20px; letter-spacing: 0.4px; }
    .container { width: 100%; max-width: 1280px; margin: 20px auto; padding: 0 24px 48px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    @media (min-width: 1200px) { .grid { grid-template-columns: 1fr 220px 1.2fr; } }
    .midcol { position: sticky; top: 76px; align-self: start; }
    .vstack { display: flex; flex-direction: column; gap: 10px; }
    .vstack button { width: 100%; } }
    @media (min-width: 1280px) { .grid { grid-template-columns: 2fr 1fr 1fr; } } }
    .card { background: linear-gradient(180deg, #121822, #0f1620); border: 1px solid var(--border); border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
    .card h2 { margin: 0 0 12px 0; font-size: 18px; }
    label { display: block; margin: 10px 0 6px; color: var(--muted); font-size: 13px; }
    select, input[type=text], input[type=number], input[type=url] { width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid var(--border); background: #0b111a; color: var(--text); outline: none; }
    input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(79,44,172,0.25); }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 800px) { .row-2 { grid-template-columns: 1fr 1fr; } .row-3 { grid-template-columns: 1fr 1fr 1fr; } }
    .muted { color: var(--muted); font-size: 12px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }
    button { padding: 11px 14px; border-radius: 10px; border: 1px solid var(--border); background: #0b111a; color: var(--text); cursor: pointer; }
    .primary { background: var(--accent); border-color: #3e2492; }
    .success { background: var(--accent-2); border-color: #e67627; color: #0b0f14; }
    .warn { background: var(--warn); border-color: #cc7e09; color: #0b0f14; }
    .danger { background: var(--danger); border-color: #c03535; }
    .pill { display:inline-block; padding: 4px 8px; border-radius: 999px; font-size: 11px; border:1px solid var(--border); background:#0b111a; color:var(--muted) }
    .list { margin-top: 10px; max-height: 520px; overflow:auto; border-radius: 12px; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
    th { position: sticky; top: 0; background: #101723; text-align: left; font-weight: 600; }
    tr:hover td { background: rgba(255,255,255,0.03); }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; background: #0b111a; border:1px solid var(--border); padding: 2px 6px; border-radius: 6px; }
    .sku { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .ok { color: #8cf0c6; }
    .bad { color: var(--danger); }
    .note { margin-top: 6px; font-size: 12px; }
    .footer { margin-top: 24px; color: var(--muted); font-size: 12px; }
  </style>
  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Hardcoded Supabase credentials (as requested). For production, prefer env vars + stricter RLS.
    const SUPABASE_URL = 'https://hnpwnjjjgxuelfognakp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhucHduampqZ3h1ZWxmb2duYWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3NTU2NDYsImV4cCI6MjA3NDMzMTY0Nn0.AVaBAzmddxnZz23YIu7IaeZzTEPI6n8CjyahRQvZSHk';
  </script>
</head>
<body>
  <header>
    <h1>JulineMart SKU Generator <span class="pill">MVP • Cloud‑sync</span></h1>
    <nav style="margin-left:auto; display:flex; gap:8px; align-items:center">
      <button id="navCreate" class="pill" style="cursor:pointer">Create</button>
      <button id="navSearch" class="pill" style="cursor:pointer">Search</button>
      <span id="sbStatus" class="pill" title="Supabase connection status">Connecting…</span>
    </nav>
  </header>
  <div class="container">
    <!-- PAGE: CREATE -->
    <section id="page-create">
      <div class="grid" style="grid-template-columns: 1fr; gap:20px">
        <div class="card">
          <h2>Create / Update SKU</h2>
          <div class="row row-2">
            <div>
              <label>Category</label>
              <select id="category"></select>
            </div>
            <div>
              <label>Category Code</label>
              <input type="text" id="categoryCode" readonly />
            </div>
          </div>
          <div class="row row-2">
            <div>
              <label>Vendor Name</label>
              <input type="text" id="vendorName" placeholder="e.g., Queen Styles" />
            </div>
            <div>
              <label>Vendor Code (3 letters)</label>
              <input type="text" id="vendorCode" placeholder="e.g., QUE" maxlength="3" />
            </div>
          </div>
          <div class="row row-3">
            <div>
              <label>Product Number (001–999)</label>
              <input type="number" id="productNumber" min="1" max="999" />
              <div class="note muted">Auto-suggests next available on Category+Vendor</div>
            </div>
            <div>
              <label>Product Name (optional)</label>
              <input type="text" id="productName" placeholder="e.g., Ankara Maxi Dress" />
            </div>
            <div>
              <label>SKU</label>
              <input type="text" id="sku" class="sku" readonly />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Product URL (optional — used for public redirect)</label>
              <input type="text" id="productUrl" placeholder="https://julinemart.com/product/..."/>
              <div class="note muted">If provided, QR will point directly to this URL. If empty, QR uses <span class="kbd">/p/&lt;SKU&gt;</span> which looks up the URL in cloud.</div>
            </div>
          </div>

          <div class="actions" style="display:flex; gap:10px; margin-top:16px">
            <button class="primary" id="suggestBtn">Suggest Number</button>
            <button class="success" id="saveBtn">Save SKU</button>
            <button id="printBtn">Print Label</button>
            <button id="clearBtn">Clear</button>
          </div>
          <div id="status" class="note"></div>
        </div>
        <div class="card">
          <h2>Branding</h2>
          <label>Upload Logo (PNG/SVG)</label>
          <input type="file" id="logoFile" accept="image/*">
          <div class="note muted">Your logo will be printed on labels and saved to this browser only.</div>
        </div>
      </div>
    </section>

    <!-- PAGE: SEARCH -->
    <section id="page-search" style="display:none">
      <div class="grid" style="grid-template-columns: 1fr; gap:20px">
        <div class="card">
          <h2>Search / Export</h2>
          <div class="row row-2">
            <div>
              <label>Filter by Category</label>
              <select id="filterCategory"></select>
            </div>
            <div>
              <label>Filter by Vendor Code</label>
              <input type="text" id="filterVendor" placeholder="e.g., QUE" maxlength="3" />
            </div>
          </div>
          <div class="actions">
            <button id="resetFilters">Reset</button>
            <button id="exportCsv">Export CSV</button>
            <button class="warn" id="importCsv">Import CSV</button>
            <input type="file" id="csvFile" accept=".csv" style="display:none" />
          </div>
          <div class="list">
            <table>
              <thead>
              <tr>
                <th>SKU</th>
                <th>Category</th>
                <th>Vendor</th>
                <th>Number</th>
                <th>Product</th>
                <th>URL</th>
                <th>Created</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
            </table>
          </div>
          <div class="footer">Storage: Local (browser) + Supabase cloud sync. Export CSV for backup.</div>
        </div>
      </div>
    </section>
  </div>

  <div id="printArea" style="display:none"></div>

  <script>
    // ===== Public route handler: /p/<SKU> redirects via Supabase if available =====
    (function handlePublicRoute(){
      try {
        var path = String(location.pathname || '');
        while (path.length > 1 && path.endsWith('/')) { path = path.slice(0, -1); }
        var re = new RegExp('^/p/([A-Za-z]{3}-[A-Za-z]{3}-\d{3})$','i');
        var m = path.match(re);
        if (!m) return; // not a public product route
        var sku = m[1].toUpperCase();
        var css = document.createElement('style');
        css.textContent = '.overlay{position:fixed;inset:0;background:#0b0f14;color:#e8eefc;display:flex;align-items:center;justify-content:center;padding:24px}'+
                          '.box{max-width:680px;width:100%;background:linear-gradient(180deg,#121822,#0f1620);border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}'+
                          '.row{margin:8px 0}.sku{font-family:ui-monospace,Consolas,monospace;font-size:18px;font-weight:700}'+
                          '.btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}'+
                          '.btn{padding:10px 14px;border-radius:10px;border:1px solid #1f2937;background:#0b111a;color:#e8eefc;cursor:pointer}'+
                          '.accent{background:#4f2cac;border-color:#3e2492}';
        document.head.appendChild(css);
        var wrap = document.createElement('div');
        wrap.className = 'overlay';
        wrap.innerHTML = '<div class="box">'+
          '<div class="row">Opening product…</div>'+
          '<div class="row sku" id="ovSku">'+sku+'</div>'+
          '<div class="row" id="ovMsg">Checking cloud mapping…</div>'+
          '<div class="btns">'+
            '<button class="btn accent" id="ovCopy">Copy SKU</button>'+
            '<a class="btn" id="ovHome" href="https://julinemart.com" target="_self">Go to JulineMart</a>'+
          '</div>'+
        '</div>';
        document.body.innerHTML = ''; document.body.appendChild(wrap);
        var msg = document.getElementById('ovMsg');
        var copyBtn = document.getElementById('ovCopy');
        copyBtn.onclick = function(){ if (navigator.clipboard) { navigator.clipboard.writeText(sku).then(function(){ msg.textContent = 'Copied '+sku+' ✅'; }).catch(function(){ msg.textContent='Copy failed — use long‑press to copy.'; }); } };
        // === Supabase query ===
        var sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{persistSession:false} });
        sb.from('skus').select('product_url').eq('sku', sku).maybeSingle().then(function(res){
          if (res.error){ msg.textContent = 'Error fetching from Supabase: '+res.error.message; return; }
          if (res.data && res.data.product_url){
            msg.textContent = 'Redirecting to product page…';
            location.replace(res.data.product_url);
          } else {
            msg.textContent = 'No product page linked to this SKU yet.';
          }
        });
      } catch(e) { /* ignore */ }
    })();

    // ===== Category Map (from your list) =====
    const CATEGORY_MAP = {
      "Fashion & Accessories": "FAS",
      "Bags": "BAG",
      "Caps & Hats": "HAT",
      "Baby Clothing": "BBC",
      "Eyewear & Sunglasses": "EYE",
      "Jewelry & Watches": "JEW",
      "Kids & Baby Clothing": "KBC",
      "Men’s Clothing": "MEN",
      "Women’s Clothing": "WMN",
      "Footwear": "FTW",
      "Traditional Wear": "TRD",
      "Automotive (General)": "AUT",
      "Engine Oil & Fluids": "OIL",
      "Car Accessories": "CAR",
      "Car Electronics": "CEL",
      "Tyres & Batteries": "TYR",
      "Motorcycle Parts": "MOT",
      "Electronics (General)": "ELE",
      "Gaming Consoles": "GAM",
      "Accessories (Chargers, Cables, Earphones)": "ACC",
      "Home Audio & Speakers": "AUD",
      "Laptops & Computers": "LAP",
      "Mobile Phones": "MOB",
      "Tablets": "TAB",
      "Televisions": "TVS",
      "Wearable Tech (Smartwatches)": "SMT",
      "Home & Living (General)": "HOM",
      "Bathroom Accessories": "BTH",
      "Bedding & Linen": "BED",
      "Furniture": "FUR",
      "Home Décor": "DEC",
      "Kitchen Appliances": "KIT",
      "Grocery & Foodstuff (General)": "GRC",
      "Drinks & Beverages": "DRK",
      "Grains & Cereals": "GRN",
      "Organic & Natural Food": "ORG",
      "Packaged Food": "PKG",
      "Snacks": "SNK",
      "Spices & Seasoning": "SPC",
      "Beauty & Personal Care (General)": "BEA",
      "Grooming Tools": "GRM",
      "Haircare": "HAI",
      "Makeup": "MUP",
      "Fragrances": "FRG",
      "Lighting": "LGT",
      "Sanitary Products": "SAN",
      "Skincare": "SKN",
      "Tools & Industrial (General)": "TOL",
      "Building Materials": "BLD",
      "Electrical Tools": "ELC",
      "Hardware": "HRD",
      "Measuring Instruments": "MSR",
      "Power Tools": "PWR",
      "Books & Education (General)": "BOK",
      "Educational Books": "EDU",
      "Novels & Literature": "NOV",
      "Religious Books": "REL",
      "Stationery": "STA",
      "School Supplies": "SCH",
      "Sports & Fitness (General)": "SPO",
      "Fitness Equipment": "FIT",
      "Gym Equipment": "GYM",
      "Water Bottles": "WAT",
      "Baby, Kids & Toys (General)": "TOY",
      "Diapers & Wipes": "DIA",
      "Baby Food & Feeding": "BFD",
      "Strollers & Carriers": "STR",
      "Toys & Games": "PLY",
      "Digital Products": "DIG"
    };

    // ===== Local storage helpers =====
    const LS_KEY = 'jm_skus_v1';
    const LS_VENDORS = 'jm_vendor_codes_v1';

    function loadSkus() { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }
    function saveSkus(list) { localStorage.setItem(LS_KEY, JSON.stringify(list)); }

    function loadVendors() { return JSON.parse(localStorage.getItem(LS_VENDORS) || '{}'); }
    function saveVendors(map) { localStorage.setItem(LS_VENDORS, JSON.stringify(map)); }

    function normalizeCode(s) { return (s || '').toUpperCase().replace(/[^A-Z]/g, '').slice(0,3); }
    function numberTo3(n) { return String(n).padStart(3, '0'); }
    function buildSku(cat, ven, num) { return `${cat}-${ven}-${numberTo3(num)}`; }
    function productUrlFromSku(sku) { return `https://julinemart.com/p/${encodeURIComponent(String(sku||'').trim())}`; }

    function nextAvailable(cat, ven) {
      const used = new Set(loadSkus().filter(x => x.category_code===cat && x.vendor_code===ven).map(x => x.number));
      for (let i=1;i<=999;i++) { if (!used.has(i)) return i; }
      return null; // full
    }

    // ===== UI elements =====
    const categorySel = document.getElementById('category');
    const categoryCode = document.getElementById('categoryCode');
    const vendorName = document.getElementById('vendorName');
    const vendorCode = document.getElementById('vendorCode');
    const productNumber = document.getElementById('productNumber');
    const productName = document.getElementById('productName');
    const productUrl = document.getElementById('productUrl');
    const skuOut = document.getElementById('sku');
    const status = document.getElementById('status');
    const suggestBtn = document.getElementById('suggestBtn');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');

    const filterCategory = document.getElementById('filterCategory');
    const filterVendor = document.getElementById('filterVendor');
    const resetFilters = document.getElementById('resetFilters');
    const exportCsv = document.getElementById('exportCsv');
    const importCsv = document.getElementById('importCsv');
    const exportMapBtn = document.getElementById('exportMap');
    const importMapBtn = document.getElementById('importMap');
    const csvFile = document.getElementById('csvFile');
    const tableBody = document.getElementById('tableBody');

    // ===== Supabase helpers =====
    function getSupabase(){
      if (!window.supabase) return null;
      if (!getSupabase._client){
        getSupabase._client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });
      }
      return getSupabase._client;
    }
    async function cloudUpsert(rec){
      const sb = getSupabase(); if (!sb) return;
      const { error } = await sb.from('skus').upsert({
        sku: rec.sku,
        category_code: rec.category_code,
        category_name: rec.category_name,
        vendor_code: rec.vendor_code,
        vendor_name: rec.vendor_name,
        number: rec.number,
        product_name: rec.product_name,
        product_url: rec.product_url,
        created_at: rec.created_at,
        updated_at: rec.updated_at,
      }, { onConflict: 'sku' });
      if (error) setStatus('Supabase upsert failed: '+error.message, 'bad');
    }
    async function cloudDelete(sku){ const sb=getSupabase(); if (!sb) return; const {error}=await sb.from('skus').delete().eq('sku', sku); if (error) setStatus('Supabase delete failed: '+error.message, 'bad'); }
    async function cloudFetchAll(){ const sb=getSupabase(); if (!sb) throw new Error('Not connected'); const { data, error } = await sb.from('skus').select('*'); if (error) throw error; return data||[]; }

    async function pullFromCloud(){
      try {
        const cloud = await cloudFetchAll();
        const local = loadSkus();
        const bySku = Object.fromEntries(local.map(r=>[r.sku, r]));
        let created=0, updated=0;
        cloud.forEach(r=>{
          const existing = bySku[r.sku];
          if (!existing){ local.push(r); created++; }
          else {
            const lu = new Date(existing.updated_at||0).getTime();
            const cu = new Date(r.updated_at||0).getTime();
            if (cu > lu){ Object.assign(existing, r); updated++; }
          }
        });
        saveSkus(local); renderTable(); setStatus(`Pulled from cloud: +${created} / updated ${updated}.`, 'ok');
      } catch(e){ setStatus('Pull failed: '+e.message, 'bad'); }
    }

    function enableLiveSync(){
      const sb=getSupabase(); if (!sb){ setStatus('Supabase not available.', 'bad'); return; }
      if (!enableLiveSync._bound){
        const _save = saveSkus;
        window.saveSkus = function(list){ _save(list); const last=list[list.length-1]; if (last) cloudUpsert(last); };
        sb.channel('skus-changes').on('postgres_changes', { event: '*', schema: 'public', table: 'skus' }, ()=>{ pullFromCloud(); }).subscribe();
        enableLiveSync._bound = true;
      }
      setStatus('Live sync enabled ✓', 'ok');
    }

    function refreshSkuField() {
      const cat = categoryCode.value;
      const ven = normalizeCode(vendorCode.value);
      const num = productNumber.value ? Number(productNumber.value) : '';
      vendorCode.value = ven;
      if (cat && ven && num) skuOut.value = buildSku(cat, ven, num); else skuOut.value = '';
    }

    function autoSuggestVendorCode() {
      const name = vendorName.value.trim();
      const map = loadVendors();
      if (map[name]) { vendorCode.value = map[name]; return; }
      const base = normalizeCode(name);
      if (!base) return;
      let code = base;
      const existingCodes = new Set(Object.values(map));
      if (existingCodes.has(code)) {
        const alt = [base.slice(0,2)+"X", base.slice(0,1)+base.slice(-2), base.slice(0,1)+"Z"+base.slice(1,2)];
        for (const c of alt) { if (!existingCodes.has(c)) { code = c; break; } }
      }
      vendorCode.value = code.padEnd(3,'X').slice(0,3);
    }

    function setStatus(msg, kind='') {
      status.innerHTML = msg;
      status.className = 'note ' + (kind==='ok' ? 'ok' : kind==='bad' ? 'bad' : '');
    }

    function renderTable() {
      const list = loadSkus();
      const fc = filterCategory.value.trim();
      const fv = normalizeCode(filterVendor.value);
      const rows = list
        .filter(r => (!fc || r.category_code===fc) && (!fv || r.vendor_code===fv))
        .sort((a,b)=> a.sku.localeCompare(b.sku));

      tableBody.innerHTML = rows.map(r => `
        <tr>
          <td class="sku">${r.sku}</td>
          <td>${r.category_code}</td>
          <td>${r.vendor_code}</td>
          <td>${numberTo3(r.number)}</td>
          <td>${(r.product_name||'').replace(/</g,'&lt;')}</td>
          <td>${(r.product_url||'').replace(/</g,'&lt;')}</td>
          <td>${new Date(r.created_at).toLocaleString()}</td>
          <td><button data-edit="${r.sku}">Edit</button> <button data-label="${r.sku}">Label</button> <button class="danger" data-del="${r.sku}">Delete</button></td>
        </tr>
      `).join('');
    }

    function fillFormFromSku(rec) {
      const name = Object.keys(CATEGORY_MAP).find(k => CATEGORY_MAP[k]===rec.category_code) || '';
      categorySel.value = name; categoryCode.value = rec.category_code;
      vendorName.value = rec.vendor_name || '';
      vendorCode.value = rec.vendor_code;
      productNumber.value = rec.number;
      productName.value = rec.product_name || '';
      productUrl.value = rec.product_url || '';
      refreshSkuField();
    }

    function suggestNumber() {
      const cat = categoryCode.value; const ven = normalizeCode(vendorCode.value);
      if (!cat || ven.length!==3) { setStatus('Select category and enter a valid 3-letter vendor code first.', 'bad'); return; }
      const nxt = nextAvailable(cat, ven);
      if (nxt==null) { setStatus('All numbers 001–999 are used for this Category+Vendor.', 'bad'); return; }
      productNumber.value = nxt; refreshSkuField();
      setStatus(`Suggested next available: <span class="kbd">${numberTo3(nxt)}</span>`, 'ok');
    }

    function saveRecord() {
      const catName = categorySel.value; const cat = categoryCode.value;
      const vName = vendorName.value.trim();
      const ven = normalizeCode(vendorCode.value);
      const num = Number(productNumber.value);
      const pname = productName.value.trim();
      const purl = productUrl.value.trim();

      if (!cat || ven.length!==3 || !num || num<1 || num>999) { setStatus('Please complete all required fields with valid values.', 'bad'); return; }
      const sku = buildSku(cat, ven, num);
      const list = loadSkus();
      const existing = list.findIndex(x => x.category_code===cat && x.vendor_code===ven && x.number===num);
      const now = new Date().toISOString();

      if (existing >= 0) {
        list[existing] = { ...list[existing], product_name: pname, vendor_name: vName, product_url: purl, updated_at: now };
        saveSkus(list);
        if (vName) { const m = loadVendors(); m[vName] = ven; saveVendors(m); }
        setStatus(`Updated existing SKU <span class="kbd">${sku}</span>.`, 'ok');
      } else {
        const rec = { sku, category_code: cat, category_name: catName, vendor_code: ven, vendor_name: vName, number: num, product_name: pname, product_url: purl, created_at: now, updated_at: now };
        list.push(rec); saveSkus(list);
        if (vName) { const m = loadVendors(); m[vName] = ven; saveVendors(m); }
        setStatus(`Saved new SKU <span class="kbd">${sku}</span>.`, 'ok');
      }
      renderTable();
      refreshSkuField();
    }

    function clearForm() {
      vendorName.value = ''; vendorCode.value=''; productNumber.value=''; productName.value=''; productUrl.value=''; skuOut.value=''; setStatus('');
    }

    // Export CSV
    function toCsv(list) {
      const head = ['sku','category_code','category_name','vendor_code','vendor_name','number','product_name','product_url','created_at','updated_at'];
      const rows = list.map(r => head.map(k => (r[k] ?? '')).map(v => '"'+String(v).replace(/"/g,'""')+'"').join(','));
      return head.join(',') + '\n' + rows.join('\n');
    }

    function download(filename, text, type='text/plain') {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text], {type}));
      a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
    }

    // Import CSV
    function parseCsv(text) {
      const lines = text.split(/\r?\n/).filter(Boolean);
      const head = lines.shift().split(',').map(s=>s.replace(/^\"|\"$/g,''));
      const out = [];
      for (const line of lines) {
        const cells = [];
        let cur = ''; let inQ=false;
        for (let i=0;i<line.length;i++) {
          const ch = line[i];
          if (ch==='"') { if (inQ && line[i+1]==='"') { cur += '"'; i++; } else { inQ=!inQ; } }
          else if (ch===',' && !inQ) { cells.push(cur); cur=''; } else { cur+=ch; }
        }
        cells.push(cur);
        const obj = {}; head.forEach((h,idx)=> obj[h] = cells[idx]?.replace(/^\"|\"$/g,'') ?? '');
        if (obj.sku) out.push(obj);
      }
      return out;
    }

    function importFromCsvText(text) {
      const rows = parseCsv(text);
      const list = loadSkus();
      const now = new Date().toISOString();
      let created=0, updated=0, skipped=0, errors=0;
      for (const r of rows) {
        try {
          const [cat, ven, numStr] = r.sku.split('-');
          const num = Number(numStr);
          if (!cat || !ven || !num || num<1 || num>999) { skipped++; continue; }
          const idx = list.findIndex(x => x.category_code===cat && x.vendor_code===ven && x.number===num);
          const rec = { sku: r.sku, category_code: cat, category_name: r.category_name || '', vendor_code: ven, vendor_name: r.vendor_name||'', number: num, product_name: r.product_name||'', product_url: r.product_url||'', created_at: r.created_at||now, updated_at: now };
          if (idx>=0) { list[idx] = { ...list[idx], ...rec }; updated++; }
          else { list.push(rec); created++; }
        } catch(e){ errors++; }
      }
      saveSkus(list); renderTable();
      setStatus(`Import done: created ${created}, updated ${updated}, skipped ${skipped}${errors?`, errors ${errors}`:''}.`, 'ok');
    }

    // Export / Import SKU → URL map
    function exportSkuMap(){
      const list = loadSkus();
      const map = {};
      list.forEach(r=>{ if (r.sku && r.product_url) map[r.sku.toUpperCase()] = r.product_url; });
      download('sku-map.json', JSON.stringify(map, null, 2), 'application/json');
      setStatus('Exported sku-map.json. Commit this file to your GitHub repo root.', 'ok');
    }
    function importSkuMapText(text){
      try{
        const map = JSON.parse(text);
        if (!map || typeof map !== 'object') throw new Error('bad map');
        const list = loadSkus();
        const now = new Date().toISOString();
        let updated = 0;
        Object.keys(map).forEach(k=>{
          const url = map[k];
          const [cat, ven, numStr] = k.split('-');
          const num = Number(numStr);
          const idx = list.findIndex(x => x.category_code===cat && x.vendor_code===ven && x.number===num);
          if (idx>=0){ if (!list[idx].product_url){ list[idx].product_url = url; list[idx].updated_at = now; updated++; } }
        });
        saveSkus(list); renderTable();
        setStatus(`Imported sku-map.json and merged: updated ${updated} records.`, 'ok');
      } catch(e){ setStatus('Failed to import sku-map.json', 'bad'); }
    }

    // Table actions (edit/delete/label)
    tableBody.addEventListener('click', (e)=>{
      const editSku = e.target.getAttribute('data-edit');
      const delSku = e.target.getAttribute('data-del');
      const labelSku = e.target.getAttribute('data-label');
      if (editSku) {
        const rec = loadSkus().find(x => x.sku===editSku);
        if (rec) fillFormFromSku(rec);
      }
      if (labelSku) {
        const rec = loadSkus().find(x => x.sku===labelSku);
        if (rec) printLabel(rec);
      }
      if (delSku) {
        if (!confirm(`Delete ${delSku}?`)) return;
        const list = loadSkus().filter(x => x.sku!==delSku);
        saveSkus(list); renderTable(); setStatus(`Deleted ${delSku}.`, 'ok');
        cloudDelete(delSku);
      }
    });

    // Event bindings
    categorySel.addEventListener('change', ()=>{ categoryCode.value = CATEGORY_MAP[categorySel.value] || ''; refreshSkuField(); });
    vendorName.addEventListener('blur', ()=>{ autoSuggestVendorCode(); refreshSkuField(); });
    vendorCode.addEventListener('input', refreshSkuField);
    productNumber.addEventListener('input', refreshSkuField);
    productName.addEventListener('input', ()=>{});

    suggestBtn.addEventListener('click', suggestNumber);
    saveBtn.addEventListener('click', saveRecord);
    // (Manual Supabase UI removed — using built-in credentials)
    clearBtn.addEventListener('click', clearForm);

    filterCategory.addEventListener('change', renderTable);
    filterVendor.addEventListener('input', renderTable);
    resetFilters.addEventListener('click', ()=>{ filterCategory.value=''; filterVendor.value=''; renderTable(); });

    exportCsv.addEventListener('click', ()=>{ download('julinemart_skus.csv', toCsv(loadSkus())); });
    importCsv.addEventListener('click', ()=> csvFile.click());
    exportMapBtn.addEventListener('click', exportSkuMap);
    importMapBtn.addEventListener('click', ()=> csvFile.click());

    csvFile.addEventListener('change', ()=>{
      const f = csvFile.files[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        if (f.name.endsWith('.json')) importSkuMapText(reader.result); else importFromCsvText(reader.result);
      };
      reader.readAsText(f); csvFile.value='';
    });

    // ===== Branding (logo) =====
    const logoFile = document.getElementById('logoFile');
    function loadLogo() { return localStorage.getItem('jm_logo_dataurl') || ''; }
    function saveLogo(dataurl) { localStorage.setItem('jm_logo_dataurl', dataurl); }
    if (logoFile) {
      logoFile.addEventListener('change', ()=>{
        const f = logoFile.files[0]; if (!f) return;
        const reader = new FileReader(); reader.onload = ()=> { saveLogo(reader.result); setStatus('Logo saved for this device. It will appear on printed labels.', 'ok'); logoFile.value=''; }; reader.readAsDataURL(f);
      });
    }

    // ===== Print label with QR (prefers product_url) =====
    function printLabel(rec){
      const logo = loadLogo();
      const sku = String(rec.sku || '').trim();
      const url = (rec.product_url && rec.product_url.trim()) || productUrlFromSku(sku);
      const qr1 = 'https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=' + encodeURIComponent(url);
      const qr2 = 'https://quickchart.io/qr?size=180&text=' + encodeURIComponent(url);
      const w = window.open('', '_blank', 'width=800,height=600');
      const styles = `body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;}
        .label{width:360px;border:1px solid #ddd;border-radius:12px;padding:16px;}
        .top{display:flex;align-items:center;gap:10px;margin-bottom:10px}
        .sku{font-family:ui-monospace,Consolas,monospace;font-size:18px;font-weight:700}
        .meta{font-size:12px;color:#444}
        .qr{margin-top:10px;display:flex;gap:12px;align-items:center}
        .title{font-size:14px;font-weight:600}
        .url{font-size:11px;color:#555;margin-top:6px;word-break:break-all}
      `;
      w.document.write(`<!DOCTYPE html><html><head><title>Label ${sku}</title><style>${styles}</style></head><body>
        <div class="label">
          <div class="top">
            ${logo?`<img src="${logo}" alt="logo" style="height:34px">`:''}
            <div>
              <div class="sku">${sku}</div>
              <div class="meta">${rec.category_name || rec.category_code} • Vendor: ${rec.vendor_code}${rec.vendor_name?` (${rec.vendor_name})`:''}</div>
              ${rec.product_name?`<div class="title">${rec.product_name.replace(/</g,'&lt;')}</div>`:''}
              <div class="url">${url}</div>
            </div>
          </div>
          <div class="qr"><img id="qr" alt="QR" width="180" height="180"><span id="fallback" style="display:none;font-size:12px;color:#666">(QR offline)</span></div>
        </div>
        <script>
          (function(){
            var img=document.getElementById('qr');
            var fb=document.getElementById('fallback');
            var QR1 = ${JSON.stringify(qr1)};
            var QR2 = ${JSON.stringify(qr2)};
            // Inject strings safely to avoid escaping issues
            QR1 = ${JSON.stringify('').slice(0,-1)} + ${JSON.stringify(qr1)} + ${JSON.stringify('').slice(1)};
            QR2 = ${JSON.stringify('').slice(0,-1)} + ${JSON.stringify(qr2)} + ${JSON.stringify('').slice(1)};
            function done(){ setTimeout(function(){ window.print(); }, 300); }
            img.onerror=function(){ if (img.src.indexOf('qrserver')!==-1){ img.src = QR2; } else { img.remove(); fb.style.display='inline'; done(); } };
            img.onload=done; img.src = QR1;
          })();
        <\/script>
      </body></html>`);
      w.document.close();
    }
<style>
  /* nav “active” state */
  .pill.active { background: var(--accent-2); color:#0b0f14; border-color:#cc7e09; }
</style>

<script>
  // --- Page toggling (Create/Search) ---
  const pageCreate = document.getElementById('page-create');
  const pageSearch = document.getElementById('page-search');
  const navCreate  = document.getElementById('navCreate');
  const navSearch  = document.getElementById('navSearch');
  const sbStatus   = document.getElementById('sbStatus');

  function showPage(which){
    if (!pageCreate || !pageSearch) return;
    pageCreate.style.display = which === 'create' ? 'block' : 'none';
    pageSearch.style.display = which === 'search' ? 'block' : 'none';
    if (navCreate && navSearch) {
      navCreate.classList.toggle('active', which === 'create');
      navSearch.classList.toggle('active', which === 'search');
    }
  }

  // attach nav events (guard in case elements are missing)
  if (navCreate) navCreate.addEventListener('click', () => showPage('create'));
  if (navSearch) navSearch.addEventListener('click', () => { renderTable(); showPage('search'); });

  // call this once at startup
  showPage('create');

  // --- Make sure action buttons are wired even if earlier code aborted once ---
  const suggestBtn = document.getElementById('suggestBtn');
  const saveBtn    = document.getElementById('saveBtn');
  const printBtn   = document.getElementById('printBtn');
  const clearBtn   = document.getElementById('clearBtn');

  if (suggestBtn && !suggestBtn._bound) { suggestBtn.addEventListener('click', suggestNumber); suggestBtn._bound = true; }
  if (saveBtn && !saveBtn._bound)    { saveBtn.addEventListener('click', saveRecord); saveBtn._bound = true; }
  if (printBtn && !printBtn._bound)  {
    printBtn.addEventListener('click', () => {
      const cat = document.getElementById('categoryCode').value;
      const ven = (document.getElementById('vendorCode').value || '').toUpperCase();
      const num = Number(document.getElementById('productNumber').value);
      if (!cat || ven.length !== 3 || !num || num < 1 || num > 999) return setStatus('Fill Category, Vendor Code and a valid number (001–999) to print.', 'bad');
      const rec = {
        sku: `${cat}-${ven}-${String(num).padStart(3,'0')}`,
        category_code: cat,
        category_name: document.getElementById('category').value,
        vendor_code: ven,
        vendor_name: (document.getElementById('vendorName').value || '').trim(),
        number: num,
        product_name: (document.getElementById('productName').value || '').trim(),
        product_url: (document.getElementById('productUrl')?.value || '').trim(),
      };
      printLabel(rec);
    });
    printBtn._bound = true;
  }
  if (clearBtn && !clearBtn._bound) { clearBtn.addEventListener('click', clearForm); clearBtn._bound = true; }

  // --- Update Supabase badge safely ---
  function setSbBadge(ok, msg){
    if (!sbStatus) return;
    sbStatus.textContent = msg || (ok ? 'Supabase ✓' : 'Supabase not available');
    sbStatus.className = 'pill ' + (ok ? 'ok' : 'bad');
  }
  // wherever you mark connection success/failure, call:
  //   setSbBadge(true, 'Supabase ✓');
  //   setSbBadge(false, 'Supabase not available');
    
    // ===== Tiny self-tests =====
    (function runSelfTests(){
      const results = [];
      function test(name, fn){ try { fn(); results.push({name, ok:true}); } catch(e){ console.error('Test failed:', name, e); results.push({name, ok:false, err:e}); } }
      test('numberTo3 pads', ()=> { if (numberTo3(7) !== '007') throw new Error('pad'); });
      test('buildSku format', ()=> { if (buildSku('WMN','QUE',7) !== 'WMN-QUE-007') throw new Error('format'); });
      test('productUrlFromSku', ()=> { if (productUrlFromSku('WMN-QUE-007') !== 'https://julinemart.com/p/WMN-QUE-007') throw new Error('url'); });
      test('route regex', ()=> { const re=/^\/p\/([A-Za-z]{3}-[A-Za-z]{3}-\d{3})$/; if (!re.test('/p/FAS-COL-001')||re.test('/p/fas-col-0001')) throw new Error('regex'); });
      const pass = results.filter(r=>r.ok).length; const el = document.getElementById('selfTest');
      if (pass === results.length) { el.textContent = 'Self‑tests: all passed'; el.classList.add('ok'); }
      else { el.textContent = `Self‑tests: ${pass}/${results.length} passed`; el.classList.add('bad'); }
    })();

    // Init
    (function init(){
      const catSel = document.getElementById('category');
      const filtSel = document.getElementById('filterCategory');
      catSel.innerHTML=''; filtSel.innerHTML='<option value="">All</option>';
      Object.keys(CATEGORY_MAP).forEach(name=>{ const code=CATEGORY_MAP[name]; const o=document.createElement('option'); o.value=name; o.textContent=name; catSel.appendChild(o); const f=document.createElement('option'); f.value=code; f.textContent=code+' — '+name; filtSel.appendChild(f); });
      document.getElementById('categoryCode').value=CATEGORY_MAP[catSel.value]||'';
      renderTable();
      // Auto-connect + live sync
      try{ pullFromCloud().then(()=> enableLiveSync()); setStatus('Connected to Supabase ✓', 'ok'); }catch(e){ /* ignore */ }
    })();
  </script>
</body>
</html>

